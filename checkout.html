<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Checkout</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>

<header class="top">
  <p>Secure Checkout • Prepaid Orders Only</p>
</header>

<main>
  <div class="card checkout">

    <h1>Checkout</h1>

    <p class="order">
      <b>Order ID:</b> <span id="orderId"></span>
    </p>

    <h3 id="productName"></h3>
    <p class="price">₹<span id="price"></span></p>

    <!-- CUSTOMER INFO -->
    <input id="name" type="text" placeholder="Full Name *">
    <input id="phone" type="tel" placeholder="Mobile Number *">
    <input id="email" type="email" placeholder="Email (optional)">

    <!-- ADDRESS -->
    <input id="address" type="text" placeholder="House / Street / Area *">
    <input id="city" type="text" placeholder="City *">
    <input id="state" type="text" placeholder="State *">
    <input id="pincode" type="number" placeholder="Pincode *">

    <p class="note">
      Your order will be confirmed after payment verification.<br>
      Returns & cancellations follow our shipping partner’s policy.
    </p>

    <button id="continueBtn" class="primary">
      Continue to Payment
    </button>

    <p id="status" class="status"></p>

  </div>
</main>

<footer>
  Need help? Contact us via WhatsApp
</footer>

<!-- ================= EMAILJS ================= -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  emailjs.init("mlvIRvITsuSCGHJMH"); // your public key
</script>

<!-- ================= FIREBASE ================= -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAcokjcwR2WEiis__c61TuXEzYXhxUlKB8",
  authDomain: "shop-template-7d574.firebaseapp.com",
  projectId: "shop-template-7d574"
});
const db = firebase.firestore();
</script>

<!-- ================= MAIN LOGIC ================= -->
<script>
const params = new URLSearchParams(window.location.search);
const product = params.get("product") || "Product";
const price = params.get("price") || "0";
const orderId = "ORD-" + Date.now();

document.getElementById("productName").innerText = product;
document.getElementById("price").innerText = price;
document.getElementById("orderId").innerText = orderId;

const statusEl = document.getElementById("status");
const btn = document.getElementById("continueBtn");

btn.onclick = async () => {
  const data = {
    customerName: name.value.trim(),
    phone: phone.value.trim(),
    email: email.value.trim() || null,
    address: address.value.trim(),
    city: city.value.trim(),
    state: state.value.trim(),
    pincode: pincode.value.trim()
  };

  if (!data.customerName || !data.phone || !data.address || !data.city || !data.state || !data.pincode) {
    alert("Please fill all required fields");
    return;
  }

  btn.disabled = true;
  statusEl.innerText = "Creating your order…";

  try {
    // 1️⃣ Save order (critical)
    await db.collection("orders").add({
      orderId,
      product,
      amount: Number(price),
      ...data,
      status: "PENDING",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // 2️⃣ Admin email (non-blocking)
    emailjs.send(
      "service_d4k3sjg",
      "template_aqune66",
      {
        order_id: orderId,
        product,
        amount: price
      }
    ).catch(()=>{});

    // 3️⃣ Customer email (optional, non-blocking)
    if (data.email) {
      emailjs.send(
        "service_d4k3sjg",
        "template_customer_confirm",
        {
          customer_email: data.email,
          order_id: orderId,
          product,
          amount: price
        }
      ).catch(()=>{});
    }

    // 4️⃣ Redirect (always happens)
    setTimeout(() => {
      window.location.href =
        `success.html?orderId=${orderId}&amount=${price}`;
    }, 400);

  } catch (err) {
    console.error(err);
    statusEl.innerText = "❌ Something went wrong. Please try again.";
    btn.disabled = false;
  }
};
</script>

</body>
</html>
