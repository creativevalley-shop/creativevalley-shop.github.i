<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout – Earmuffs</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>

<header>
  <h1>Checkout</h1>
</header>

<main>
  <div class="product">
    <h2 id="product"></h2>
    <p class="price">₹<span id="price"></span></p>

    <p><b>Order ID:</b> <span id="orderId"></span></p>

    <p class="note">
      ⚠️ Please ensure the <b>Order ID</b> is visible in the UPI payment note.
    </p>

    <button id="payBtn">Pay Now via UPI</button>
    <p id="status"></p>
  </div>
</main>

<!-- ================= EMAILJS ================= -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  (function () {
    emailjs.init("mlvIRvITsuSCGHJMH"); // ✅ YOUR PUBLIC KEY
  })();
</script>

<!-- ================= FIREBASE ================= -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAcokjcwR2WEiis__c61TuXEzYXhxUlKB8",
    authDomain: "shop-template-7d574.firebaseapp.com",
    projectId: "shop-template-7d574"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

<!-- ================= MAIN LOGIC ================= -->
<script>
  /* ---------- GET PRODUCT DATA ---------- */
  const params = new URLSearchParams(window.location.search);
  const product = params.get("product") || "Earmuffs";
  const price = params.get("price") || "499";

  /* ---------- GENERATE ORDER ID ---------- */
  const orderId = "ORD-" + Date.now();

  /* ---------- DISPLAY ---------- */
  document.getElementById("product").innerText = product;
  document.getElementById("price").innerText = price;
  document.getElementById("orderId").innerText = orderId;

  const payBtn = document.getElementById("payBtn");
  const statusEl = document.getElementById("status");

  /* ---------- UPI LINK ---------- */
  const upiId = "7978990755@axl";
  const upiLink =
    `upi://pay?pa=${upiId}&pn=EarmuffsStore&am=${price}&cu=INR&tn=${orderId}`;

  /* ---------- BUTTON CLICK ---------- */
  payBtn.addEventListener("click", async () => {
    payBtn.disabled = true;
    statusEl.innerText = "Creating order…";

    try {
      /* 1️⃣ SAVE ORDER (BLOCKING – MUST SUCCEED) */
      await db.collection("orders").add({
        orderId: orderId,
        product: product,
        amount: Number(price),
        status: "PENDING",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      /* 2️⃣ SEND EMAIL (NON-BLOCKING) */
      emailjs.send(
        "service_d4k3sjg",   // ✅ SERVICE ID
        "template_aqune66",  // ✅ TEMPLATE ID
        {
          order_id: orderId,
          product: product,
          amount: price
        }
      ).then(
        () => console.log("Email sent"),
        err => console.error("Email error", err)
      );

      /* 3️⃣ REDIRECT TO UPI (ALWAYS) */
      statusEl.innerText = "Redirecting to UPI…";
      setTimeout(() => {
        window.location.href = upiLink;
      }, 500);

    } catch (err) {
      console.error("ORDER ERROR:", err);
      statusEl.innerText = "❌ Failed to create order. Try again.";
      payBtn.disabled = false;
    }
  });
</script>

</body>
</html>
